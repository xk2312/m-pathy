name: Deploy Staging
on:
  push:
    branches: [ staging ]

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4

      # Optional: Wenn du lokal bauen willst, ent-kommentieren/anpassen
      # - uses: actions/setup-node@v4
      #   with: { node-version: 'lts/*' }
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build

      - name: Prepare SSH
        run: |
          install -m 700 -d ~/.ssh
          printf "%s\n" "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf "%s\n" "${{ secrets.STAGING_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Rsync to server
        run: |
          RSYNC_RSH="ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes"
          rsync -az --delete \
            --exclude ".git" \
            --exclude "node_modules" \
            --exclude ".env" --exclude ".env.*" \
            -e "$RSYNC_RSH" ./ ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:/srv/app/current/

      - name: Restart service
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes \
            ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} \
            'sudo systemctl daemon-reload && sudo systemctl restart mpathy.service && sudo systemctl status mpathy.service --no-pager --lines=20'
